<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Once!</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline';"
    />
    <link rel="stylesheet" href="style.css" />
  </head>

  <body>
    <div id="stories">
      <div id="search">
        <input type="text" id="searchfield" placeholder="search" />
      </div>
    </div>
    <div id="sep_slider"></div>
    <div id="content">
      <iframe id="frams" name="frams"></iframe>
    </div>
  </body>
</html>

<script>
  const { remote, shell, clipboard, ipcRenderer } = require("electron")
  const { Menu, MenuItem } = remote
  const filters = require("./filters")
  const story_parser = require("./parser")
  const seperation_slider = require("./sep_slider")
  seperation_slider.init_slider()

  searchfield.addEventListener("input", (x) => {
    console.log(x)
    if (x.target.value.length > 0) {
      event.target.focus()
      ipcRenderer.send("search-text", event.target.value)
    }
  })

  searchfield.addEventListener("keyup", (x) => {
    if (event.keyCode === 13) {
      if (x.target.value.length > 0) {
        ipcRenderer.send("search-text", event.target.value)
        event.target.focus()
      }
    }
  })

  const stupidMenu = {
    rightClickPosition: null,
    target: null,
  }

  const menu = new Menu()
  menu.append(
    new MenuItem({
      label: "Copy URL",
      click() {
        clipboard.writeText(stupidMenu.target.href, "selection")
      },
    })
  )
  menu.append(
    new MenuItem({
      label: "Open in Browser",
      click: async () => {
        await shell.openExternal(stupidMenu.target.href)
      },
    })
  )
  menu.append(
    new MenuItem({
      label: "test",
      click: () => {
        remote
          .getCurrentWindow()
          .inspectElement(
            stupidMenu.rightClickPosition.x,
            stupidMenu.rightClickPosition.y
          )
      },
    })
  )

  function read_story(href) {
    let readlist = localStorage.getItem("readlist")
    try {
      readlist = JSON.parse(readlist)
    } catch (e) {
      readlist = []
    }
    return readlist.includes(href)
  }

  function add_story(story) {
    story = filters.filter_story(story)
    if (story === false) {
      return
    }

    let stories_container = document.querySelector("#stories")
    let new_story = document.createElement("div")
    new_story.classList.add("story")
    if (read_story(story.href)) {
      new_story.classList.add("read")
    }
    let link = document.createElement("a")
    link.href = story.href
    link.target = "frams"
    let title = document.createElement("h2")
    title.innerText = story.title

    let info = document.createElement("div")
    let type = document.createElement("p")
    type.innerText = "[" + story.type + "]"
    type.style.backgroundColor = story.colors[0]
    type.style.color = story.colors[1]
    type.style.display = "inline-block"
    info.appendChild(type)
    info.appendChild(document.createTextNode(" (" + link.hostname + ")"))

    let og_link = document.createElement("a")
    og_link.innerText = " [OG] "
    og_link.href = story.href
    og_link.target = "frams"

    info.appendChild(og_link)
    title.appendChild(info)
    link.appendChild(title)
    new_story.appendChild(link)

    let read_btn = document.createElement("div")
    read_btn.classList.add("btn")
    read_btn.classList.add("read_btn")
    read_btn.innerText = "read"
    read_btn.onclick = (x) => {
      if (!new_story.classList.contains("read")) {
        new_story.classList.add("read")
        mark_as_read(story.href)
      }
    }
    new_story.appendChild(read_btn)

    let filter_btn = document.createElement("div")
    filter_btn.classList.add("btn")
    filter_btn.classList.add("filter_btn")
    filter_btn.innerText = "filter"
    filter_btn.onclick = (x) => {
      console.log(filter)
    }
    new_story.appendChild(filter_btn)

    new_story.addEventListener(
      "contextmenu",
      (e) => {
        e.preventDefault()
        stupidMenu.target = story
        stupidMenu.rightClickPosition = {
          x: e.x,
          y: e.y,
        }
        menu.popup({
          window: remote.getCurrentWindow(),
        })
      },
      false
    )

    new_story.addEventListener(
      "click",
      (e) => {
        document.querySelectorAll(".story").forEach((x) => {
          if (x.classList.contains("read")) {
            document.querySelector("#stories").appendChild(x)
          }
          x.classList.remove("selected")
        })
        new_story.classList.add("selected")
        if (!new_story.classList.contains("read")) {
          new_story.classList.add("read")
          mark_as_read(story.href)
        }
      },
      false
    )

    stories_container.appendChild(new_story)
  }

  function mark_as_read(href) {
    let readlist = localStorage.getItem("readlist")
    try {
      readlist = JSON.parse(readlist)
    } catch (e) {
      readlist = []
    }
    readlist.push(href)
    localStorage.setItem("readlist", JSON.stringify(readlist))
  }

  let urls = [
    "https://news.ycombinator.com/",
    "https://news.ycombinator.com/news?p=2",
    "https://news.ycombinator.com/news?p=3",
    "https://lobste.rs/",
  ]

  urls.forEach((url) => {
    fetch(url).then((x) => {
      if (x.ok) {
        x.text().then((val) => {
          let dom_parser = new DOMParser(val)
          let doc = dom_parser.parseFromString(val, "text/html")
          story_parser.parse(url, doc)
          document.querySelectorAll(".story").forEach((x) => {
            if (x.classList.contains("read")) {
              document.querySelector("#stories").appendChild(x)
            }
          })
        })
      }
    })
  })
</script>
